<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>QuickDesk - Ticket Detail</title>
<style>
	body {
		background-color: #121212;
		color: #e0e0e0;
		font-family: 'Inter', 'Roboto', Arial, sans-serif;
		margin: 0;
	}
	nav {
		background-color: #1f1f1f;
		padding: 10px 20px;
	}
	nav a {
		color: #00acc1;
		text-decoration: none;
		font-weight: 700;
		font-size: 1.5rem;
	}
	nav a:hover {
		text-decoration: underline;
	}
	.container {
		max-width: 800px;
		margin: 30px auto;
		padding: 0 20px;
	}
	.card, .comment-box {
		background-color: #1f1f1f;
		border-radius: 12px;
		box-shadow: 0 0 20px rgba(0,172,193,0.3);
		padding: 20px;
		margin-bottom: 20px;
	}
	#ticketDescription {
		background-color: #2a2a2a;
		padding: 15px;
		border-radius: 8px;
		color: #e0e0e0;
		white-space: pre-wrap;
		margin-bottom: 1rem;
	}
	#commentsSection {
		max-height: 280px;
		overflow-y: auto;
		background: #242424;
		padding: 15px;
		border-radius: 8px;
		border: 1px solid #444;
	}
	#commentsSection > div {
		margin-bottom: 15px;
		padding: 10px 15px;
		border-radius: 8px;
		background-color: #292929;
	}
	#commentsSection > div.comment-agent {
		background-color: #2c2c2c;
	}
	#commentsSection small {
		color: #bbb;
		display: block;
		margin-bottom: 4px;
	}
	textarea {
		width: 100%;
		padding: 8px 12px;
		border-radius: 8px;
		border: 1px solid #444;
		background: #2c2c2c;
		color: #e0e0e0;
		resize: vertical;
		font-family: inherit;
		font-size: 1rem;
	}
	textarea:focus {
		border-color: #00acc1;
		box-shadow: 0 0 8px #00acc1;
		outline: none;
		background: #2c2c2c;
	}
	button {
		padding: 10px 20px;
		background-color: #00acc1;
		border: none;
		color: white;
		border-radius: 8px;
		font-weight: 600;
		font-size: 1rem;
		cursor: pointer;
	}
	button:hover {
		background-color: #0097a7;
	}
	.invalid-feedback {
		color: #ff4c4c;
		margin-top: 5px;
		display: none;
	}
	textarea.is-invalid + .invalid-feedback {
		display: block;
	}
  #closeBtn {
    position: absolute;
    right: 30px;
    top: 30px;
    background: #ff6b6b;
    border: none;
    color: white;
    padding: 8px 14px;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(255,107,107, 0.6);
  }
  #closeBtn:hover {
    background: #e55555;
  }
  .header-wrapper {
    position: relative;
  }
</style>
</head>
<body>

<nav><a href="index.html">QuickDesk</a></nav>

<div class="container">
  <div class="card header-wrapper">
    <h3 id="ticketSubject">Loading...</h3>
    <button id="closeBtn" aria-label="Close ticket detail and go back to dashboard">Close</button>
    <p><b>Category:</b> <span id="ticketCategory"></span></p>
    <p><b>Status:</b> <span id="ticketStatus" class="badge"></span></p>
    <p><b>Last Updated:</b> <span id="ticketUpdated"></span></p>
    <hr />
    <p id="ticketDescription"></p>
  </div>

  <h5>Conversation</h5>
  <div id="commentsSection"></div>

  <form id="commentForm" class="comment-box" novalidate>
    <textarea id="commentText" rows="3" placeholder="Add a reply..." required></textarea>
    <div class="invalid-feedback">Please enter a reply.</div>
    <button type="submit">Reply</button>
  </form>
</div>

<script>
  function checkAuth() {
    if(!localStorage.getItem('quickdesk_token')) {
      window.location.href = 'login.html';
    }
  }
  function getQueryParam(param){
    const params = new URLSearchParams(window.location.search);
    return params.get(param);
  }
  function getTickets() {
    return JSON.parse(localStorage.getItem('quickdesk_tickets')) || [];
  }
  function saveTickets(tickets){
    localStorage.setItem('quickdesk_tickets', JSON.stringify(tickets));
  }
  function getStatusClass(status) {
    switch(status) {
      case 'Open': return 'badge-status-open';
      case 'In Progress': return 'badge-status-inprogress';
      case 'Resolved': return 'badge-status-resolved';
      case 'Closed': return 'badge-status-closed';
      default: return '';
    }
  }
  function renderTicketDetail(ticket, commentsContainer) {
    document.getElementById('ticketSubject').textContent = ticket.subject;
    document.getElementById('ticketCategory').textContent = ticket.category;
    const statusSpan = document.getElementById('ticketStatus');
    statusSpan.textContent = ticket.status;
    statusSpan.className = 'badge ' + getStatusClass(ticket.status);
    document.getElementById('ticketUpdated').textContent = ticket.lastUpdated;
    document.getElementById('ticketDescription').textContent = ticket.description;

    commentsContainer.innerHTML = '';
    ticket.comments.forEach(comment => {
      const div = document.createElement('div');
      div.className = comment.author === 'Agent' ? 'comment-agent' : '';
      div.innerHTML = `<small>${comment.author} â€¢ ${comment.time}</small><p>${comment.text}</p>`;
      commentsContainer.appendChild(div);
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    checkAuth();

    const closeBtn = document.getElementById('closeBtn');
    closeBtn.addEventListener('click', () => {
      window.location.href = 'index.html';
    });

    let tickets = getTickets();
    const ticketId = parseInt(getQueryParam('id'));
    if(!ticketId){
      alert('No ticket specified');
      window.location.href = 'index.html';
      return;
    }

    const ticket = tickets.find(t=>t.id === ticketId);
    if(!ticket){
      alert('Ticket not found');
      window.location.href = 'index.html';
      return;
    }

    const commentsSection = document.getElementById('commentsSection');
    renderTicketDetail(ticket, commentsSection);

    const form = document.getElementById('commentForm');
    form.addEventListener('submit', e => {
      e.preventDefault();
      const textarea = document.getElementById('commentText');
      const text = textarea.value.trim();

      if(!text){
        textarea.classList.add('is-invalid');
        return;
      }
      textarea.classList.remove('is-invalid');

      const now = new Date().toISOString().slice(0,16).replace('T',' ');
      const userEmail = localStorage.getItem('quickdesk_user_email') || 'unknown@user.com';

      ticket.comments.push({author: userEmail, text: text, time: now});
      ticket.replies++;
      ticket.lastUpdated = now;

      const idx = tickets.findIndex(t => t.id === ticket.id);
      tickets[idx] = ticket;
      saveTickets(tickets);

      textarea.value = '';
      renderTicketDetail(ticket, commentsSection);
    });
  });
</script>

</body>
</html>

